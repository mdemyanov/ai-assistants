// =============================================================================
// ПРИМЕРЫ: Скрипты вычисления атрибутов
// =============================================================================

// -----------------------------------------------------------------------------
// Пример 1: Вычислимый атрибут - подсчет связанных объектов
// Категория: Скрипт вычисления значения атрибута (вычислимый)
// Место: Администрирование → Атрибуты → Скрипт вычисления
// -----------------------------------------------------------------------------
return utils.count('file', ['source': subject.UUID])

// -----------------------------------------------------------------------------
// Пример 2: Вычислимый атрибут - сумма значений связанных объектов
// Категория: Скрипт вычисления значения атрибута (вычислимый)
// -----------------------------------------------------------------------------
//ПАРАМЕТРЫ------------------------------------------------------------
def LINKS_ATTR = 'linkedItems'
def AMOUNT_ATTR = 'amount'

//ОСНОВНОЙ БЛОК--------------------------------------------------------
def allCost = 0
def linkedObjects = subject."${LINKS_ATTR}"

if (linkedObjects) {
    linkedObjects.each { item ->
        allCost += item."${AMOUNT_ATTR}" ?: 0
    }
}

return allCost

// -----------------------------------------------------------------------------
// Пример 3: Вычисление при редактировании - автозаполнение ответственного
// Категория: Скрипт вычисления значения атрибута при редактировании
// Место: Администрирование → Атрибуты → Скрипт вычисления при редактировании
// -----------------------------------------------------------------------------
// Если ответственный уже указан на форме - не меняем
if (form?.responsibleEmployee) {
    return form.responsibleEmployee
}

// Если это редактирование существующего объекта
if (subject?.responsibleEmployee) {
    return subject.responsibleEmployee
}

// Автозаполнение из услуги
return subject?.service?.defaultResponsible

// -----------------------------------------------------------------------------
// Пример 4: Вычисление при редактировании - зависимость от другого поля
// Категория: Скрипт вычисления значения атрибута при редактировании
// -----------------------------------------------------------------------------
//ПАРАМЕТРЫ------------------------------------------------------------
def SOURCE_ATTR = 'clientEmployee'
def TARGET_ATTR = 'clientOU'

//ОСНОВНОЙ БЛОК--------------------------------------------------------
// Получаем значение из формы или из объекта
def client = form?."${SOURCE_ATTR}" ?: subject?."${SOURCE_ATTR}"

// Если клиент указан - берем его отдел
if (client) {
    return client.parent
}

// Иначе оставляем текущее значение
return form?."${TARGET_ATTR}" ?: subject?."${TARGET_ATTR}"

// -----------------------------------------------------------------------------
// Пример 5: Вычисление значения по умолчанию
// Категория: Скрипт вычисления значения по умолчанию для атрибута
// Место: Администрирование → Атрибуты → Значение по умолчанию
// -----------------------------------------------------------------------------
// Для формы добавления - текущий пользователь как автор
if (origin == 'addForm') {
    return user
}

// Для редактирования - не меняем
return subject?.author

// -----------------------------------------------------------------------------
// Пример 6: Вычисление даты по умолчанию
// Категория: Скрипт вычисления значения по умолчанию
// -----------------------------------------------------------------------------
//ПАРАМЕТРЫ------------------------------------------------------------
def DEFAULT_DAYS_OFFSET = 3
def WORKING_DAYS_ONLY = true

//ФУНКЦИИ--------------------------------------------------------------
def addWorkingDays(date, days) {
    def result = date
    def added = 0
    while (added < days) {
        result = api.date.addDays(result, 1)
        def dayOfWeek = result.format('u') as Integer
        // Пропускаем выходные (6=Сб, 7=Вс)
        if (dayOfWeek < 6) {
            added++
        }
    }
    return result
}

//ОСНОВНОЙ БЛОК--------------------------------------------------------
def baseDate = new Date()

if (WORKING_DAYS_ONLY) {
    return addWorkingDays(baseDate, DEFAULT_DAYS_OFFSET)
} else {
    return api.date.addDays(baseDate, DEFAULT_DAYS_OFFSET)
}

// -----------------------------------------------------------------------------
// Пример 7: Формирование номера объекта
// Категория: Скрипт вычисления значения атрибута (вычислимый)
// -----------------------------------------------------------------------------
//ПАРАМЕТРЫ------------------------------------------------------------
def PREFIX = 'INC'
def COUNTER_ATTR = 'internalNumber'

//ОСНОВНОЙ БЛОК--------------------------------------------------------
def number = subject."${COUNTER_ATTR}"
if (!number) return null

def year = new Date().format('yy')
return "${PREFIX}-${year}-${String.format('%06d', number)}"

// -----------------------------------------------------------------------------
// Пример 8: Ограничение значений даты (минимум/максимум)
// Категория: Скрипт ограничения значения атрибутов типа "Дата"
// Место: Администрирование → Атрибуты → Ограничение значений
// -----------------------------------------------------------------------------
//ПАРАМЕТРЫ------------------------------------------------------------
def MIN_DAYS_FROM_NOW = 0  // Сегодня и позже
def MAX_DAYS_FROM_NOW = 30 // Не более 30 дней вперед

//ОСНОВНОЙ БЛОК--------------------------------------------------------
def today = new Date().clearTime()
def minDate = api.date.addDays(today, MIN_DAYS_FROM_NOW)
def maxDate = api.date.addDays(today, MAX_DAYS_FROM_NOW)

return [
    'min': minDate,
    'max': maxDate
]
