// =============================================================================
// ПРИМЕРЫ: Скрипты действий по событию
// =============================================================================

// -----------------------------------------------------------------------------
// Пример 1: Добавить комментарий при изменении названия
// Категория: Системное действие по событию
// Событие: Редактирование объекта
// -----------------------------------------------------------------------------
if (changedAttributes.contains('title')) {
    utils.create('comment', [
        'text': "Название изменено с '${oldSubject.title}' на '${subject.title}'",
        'source': subject.UUID
    ])
}

// -----------------------------------------------------------------------------
// Пример 2: Автоназначение ответственного при создании
// Категория: Системное действие по событию
// Событие: Добавление объекта
// -----------------------------------------------------------------------------
//ПАРАМЕТРЫ------------------------------------------------------------
def DEFAULT_RESPONSIBLE_ATTR = 'defaultResponsible'

//ОСНОВНОЙ БЛОК--------------------------------------------------------
if (!subject.responsibleEmployee) {
    def defaultResp = subject?.service?."${DEFAULT_RESPONSIBLE_ATTR}"
    if (defaultResp) {
        utils.edit(subject, ['responsibleEmployee': defaultResp])
    }
}

// -----------------------------------------------------------------------------
// Пример 3: Смена статуса при принятии в работу
// Категория: Системное действие по событию
// Событие: Редактирование объекта
// -----------------------------------------------------------------------------
//ПАРАМЕТРЫ------------------------------------------------------------
def ALLOWED_STATES = ['registered', 'assigned']
def TARGET_STATE = 'inProgress'

//ОСНОВНОЙ БЛОК--------------------------------------------------------
if (subject.responsibleEmployee &&
    ALLOWED_STATES.contains(subject.state)) {
    utils.edit(subject, ['state': TARGET_STATE])
}

// -----------------------------------------------------------------------------
// Пример 4: Возврат в предыдущий статус при комментарии
// Категория: Системное действие по событию
// Событие: Добавление комментария
// -----------------------------------------------------------------------------
//ПАРАМЕТРЫ------------------------------------------------------------
def ALLOWED_STATES = ['resumed', 'pending']

//ОСНОВНОЙ БЛОК--------------------------------------------------------
def stateEvt = utils.lastState(subject)
def lastStateCode = stateEvt.stateCode
def currentStateCode = stateEvt.newStateCode

if (ALLOWED_STATES.contains(subject.state)) {
    utils.edit(subject, ['state': lastStateCode])
    logger.debug("Статус изменен с ${currentStateCode} на ${lastStateCode}")
}

// -----------------------------------------------------------------------------
// Пример 5: Пользовательское действие - подписка на запросы
// Категория: Пользовательское действие по событию
// Вызов: Кнопка в списке объектов
// -----------------------------------------------------------------------------
//ОСНОВНОЙ БЛОК--------------------------------------------------------
def subscribed = []
def alreadySubscribed = []

subjects.each { obj ->
    def currentSubs = obj.subscribers ?: []
    if (!currentSubs.contains(user)) {
        utils.edit(obj, ['subscribers': currentSubs + user])
        subscribed << obj.number
    } else {
        alreadySubscribed << obj.number
    }
}

def message = ""
if (subscribed) {
    message += "Подписка оформлена: ${subscribed.join(', ')}\n"
}
if (alreadySubscribed) {
    message += "Уже подписаны: ${alreadySubscribed.join(', ')}"
}

result.showMessage(message ?: 'Нет выбранных объектов')

// -----------------------------------------------------------------------------
// Пример 6: Пользовательское действие с параметрами формы
// Категория: Пользовательское действие по событию
// Вызов: Кнопка с формой параметров
// -----------------------------------------------------------------------------
//ПАРАМЕТРЫ------------------------------------------------------------
def COMMENT_PARAM = 'userComment'
def NEW_STATE_PARAM = 'targetState'

//ОСНОВНОЙ БЛОК--------------------------------------------------------
def comment = params."${COMMENT_PARAM}"
def newState = params."${NEW_STATE_PARAM}"

subjects.each { obj ->
    def attrs = [:]

    if (newState) {
        attrs['state'] = newState
    }

    if (comment) {
        utils.create('comment', [
            'text': comment,
            'source': obj.UUID
        ])
    }

    if (attrs) {
        utils.edit(obj, attrs)
    }
}

result.showMessage("Обработано объектов: ${subjects.size()}")

// -----------------------------------------------------------------------------
// Пример 7: Оповещение с кастомизацией
// Категория: Скрипт кастомизации оповещения
// Событие: Оповещение (email/telegram)
// -----------------------------------------------------------------------------
//ПАРАМЕТРЫ------------------------------------------------------------
def PRIORITY_ATTR = 'urgency'
def HIGH_PRIORITY_CODE = 'high'

//ОСНОВНОЙ БЛОК--------------------------------------------------------
if (subject."${PRIORITY_ATTR}"?.code == HIGH_PRIORITY_CODE) {
    notification.subject = "[СРОЧНО] ${notification.subject}"
}

// Добавить информацию в тело письма
notification.body += """

---
Ответственный: ${subject.responsibleEmployee?.title ?: 'Не назначен'}
Услуга: ${subject.service?.title ?: 'Не указана'}
"""

// -----------------------------------------------------------------------------
// Пример 8: Эскалация по уровням
// Категория: Действие по событию эскалации
// Событие: Эскалация
// -----------------------------------------------------------------------------
//ПАРАМЕТРЫ------------------------------------------------------------
def ESCALATION_GROUPS = [
    1: 'team$firstLine',
    2: 'team$secondLine',
    3: 'team$managers'
]

//ОСНОВНОЙ БЛОК--------------------------------------------------------
def targetGroup = ESCALATION_GROUPS[escalationLevel]

if (targetGroup) {
    def team = utils.load(targetGroup)
    if (team) {
        utils.edit(subject, ['responsibleTeam': team])
        utils.create('comment', [
            'text': "Эскалация уровня ${escalationLevel}. Назначена группа: ${team.title}",
            'source': subject.UUID
        ])
    }
}
