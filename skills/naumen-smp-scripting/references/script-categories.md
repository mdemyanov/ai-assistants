# Категории скриптов Naumen SMP

## 1. Скрипт действия по событию (системные)

**Место:** Администрирование → Действия по событиям → Скрипт
**Когда:** При наступлении события (добавление, редактирование, смена статуса)

### Контекстные переменные

| Переменная | Тип | Описание |
|------------|-----|----------|
| `subject` | Object | Текущий объект (может быть null при удалении) |
| `oldSubject` | Object | Объект до изменения (null при добавлении) |
| `currentSubject` | Object | Актуальное состояние после предыдущих действий |
| `changedAttributes` | List | Коды измененных атрибутов |
| `user` | Employee | Инициатор события (null если суперпользователь) |
| `sourceObject` | Object | Добавленный файл/комментарий |
| `cardObject` | Object | Объект карточки (null если не из карточки) |
| `comment` | String | Текст комментария при смене статуса/ответственного |
| `commentObject` | Object | Объект созданного комментария |
| `escalationLevel` | Integer | Уровень эскалации (начинается с 1) |

### Особенности

- **Асинхронное** — выполняется с задержкой, не блокирует UI
- **Синхронное** — выполняется сразу, блокирует UI, откатывается при ошибке
- Глубина вложенных событий ограничена 8 уровнями

### Пример: Комментарий при изменении названия

```groovy
if (changedAttributes.contains('title')) {
    utils.create('comment', [
        'text': "Старое название: ${oldSubject.title}",
        'source': subject.UUID
    ])
}
```

---

## 2. Скрипт действия по событию (пользовательские)

**Место:** Администрирование → Действия по событиям → Скрипт (пользовательское событие)
**Когда:** При нажатии кнопки пользователем

### Контекстные переменные

| Переменная | Тип | Описание |
|------------|-----|----------|
| `subjects` | List | Выбранные объекты |
| `subject` | Object | Произвольный из subjects |
| `params` | Map | Параметры с формы действия |
| `result` | Object | Управление результатом |
| `source` | String | OBJECT_LIST или OBJECT_CARD |
| `cardObject` | Object | Объект карточки (если из карточки) |
| `list` | Collection | Все объекты списка (макс 1000) |

### Методы result

```groovy
result.showMessage('Сообщение пользователю')
result.goToUrl('https://example.com', true) // true = новая вкладка
result.redirectToObject(newObject)
result.redirectToList('serviceCall')
result.close() // закрыть форму
```

### Пример: Подписка на запросы

```groovy
subjects.each { obj ->
    def currentSubs = obj.subscribers ?: []
    if (!currentSubs.contains(user)) {
        utils.edit(obj, ['subscribers': currentSubs + user])
    }
}
result.showMessage('Вы подписаны на выбранные запросы')
```

---

## 3. Скрипт вычисления значения атрибута (вычислимый)

**Место:** Администрирование → Атрибуты → Скрипт вычисления
**Когда:** При отрисовке контента (каждый раз!)

### Контекстные переменные

| Переменная | Описание |
|------------|----------|
| `subject` | Владелец атрибута |
| `cardObject` | Объект карточки |
| `origin` | Тип формы: readForm/addForm/editForm |

### Особенности

- **Запрещены внешние источники** (HTTP, SOAP)
- Может снизить производительность
- Значение НЕ хранится в БД

### Пример: Подсчет связанных файлов

```groovy
return utils.count('file', ['source': subject.UUID])
```

---

## 4. Скрипт вычисления значения при редактировании

**Место:** Администрирование → Атрибуты → Скрипт вычисления при редактировании
**Когда:** При открытии формы редактирования

### Контекстные переменные

| Переменная | Описание |
|------------|----------|
| `subject` | Редактируемый объект |
| `form` | Значения на форме |
| `initialValues` | Начальные значения атрибутов |
| `origin` | Тип формы |

### Пример: Автозаполнение ответственного

```groovy
if (!form?.responsibleEmployee) {
    return subject?.service?.defaultResponsible
}
return form.responsibleEmployee
```

---

## 5. Скрипт фильтрации значений атрибута

**Место:** Администрирование → Атрибуты → Скрипт фильтрации
**Когда:** При выборе значения атрибута

### Двухчастная структура

```groovy
// Часть 1: В админ-интерфейсе (subject == null)
def ATTRS_FOR_UPDATE = ['clientEmployee', 'service']
if (subject == null) {
    return ATTRS_FOR_UPDATE
}

// Часть 2: В интерфейсе оператора
def client = form?.clientEmployee?.parent ?: form?.clientOU
if (!client) return api.filtration.disableFiltration()

return utils.find('service', ['clients': op.in(client)])
```

### Контекстные переменные

| Переменная | Описание |
|------------|----------|
| `subject` | Владелец атрибута (null в админке) |
| `attrCode` | Код фильтруемого атрибута |
| `form` | Значения на форме |
| `sourceForm` | Значения полей источника |
| `origin` | Тип формы |

### Важно

- Если может вернуть >500 объектов — используй `api.filtration.disableFiltration()`

---

## 6. Скрипт действия при входе/выходе из статуса

**Место:** Администрирование → Статусы → Действие при входе/выходе
**Когда:** При переходе в/из статуса

### Контекстные переменные

| Переменная | Описание |
|------------|----------|
| `subject` | Объект, меняющий статус |
| `user` | Инициатор смены статуса |

### Пример: Установить дату закрытия

```groovy
if (subject.state == 'closed') {
    utils.edit(subject, ['closedDate': new Date()])
}
```

---

## 7. Скрипт условия действия/перехода

**Место:** Администрирование → Действия по событиям → Условие
**Когда:** Перед выполнением действия/перехода

### Возвращаемое значение

- `true` — действие/переход разрешен
- `false` — запрещен

### Пример: Проверка заполненности

```groovy
return subject.responsibleEmployee != null && subject.description?.trim()
```

---

## 8. Скрипт задачи планировщика

**Место:** Администрирование → Планировщик → Скрипт
**Когда:** По расписанию

### Контекстные переменные

| Переменная | Описание |
|------------|----------|
| `user` | null (выполняется системой) |

### Пример: Ежедневная обработка

```groovy
def oldCalls = utils.find('serviceCall', [
    'state': 'registered',
    'registeredDate': op.lt(api.date.addDays(new Date(), -7))
], sp.limit(100))

oldCalls.each { sc ->
    utils.edit(sc, ['state': 'escalated'])
}
```

---

## 9. Скрипт конфигурации импорта

**Место:** Администрирование → Импорт → Конфигурация
**Когда:** При импорте данных

### Контекстные переменные

| Переменная | Описание |
|------------|----------|
| `row` | Текущая строка импорта (Map) |
| `subject` | Найденный/созданный объект |

---

## 10. Скрипт обработки входящей почты

**Место:** Администрирование → Обработка почты → Правило
**Когда:** При получении письма

### Контекстные переменные

| Переменная | Описание |
|------------|----------|
| `message` | Объект письма |
| `message.subject` | Тема письма |
| `message.from` | Отправитель |
| `message.body` | Тело письма |
| `message.attachments` | Вложения |

---

## 11. Скрипт шаблона отчета

**Место:** Администрирование → Отчеты → Шаблон
**Когда:** При формировании отчета

### Контекстные переменные

| Переменная | Описание |
|------------|----------|
| `params` | Параметры отчета |
| `user` | Пользователь, запустивший отчет |

---

## 12. Скрипт текста модуля

**Место:** Администрирование → Скриптовые модули
**Когда:** При вызове из других скриптов

### Вызов модуля

```groovy
def result = modules.myModuleCode.myMethod(param1, param2)
```

### Структура модуля

```groovy
class MyModule {
    static def myMethod(def param1, def param2) {
        // логика
        return result
    }
}
```

---

## 13. Скрипт определения прав доступа

**Место:** Администрирование → Роли → Скрипт прав
**Когда:** При проверке доступа

### Контекстные переменные

| Переменная | Описание |
|------------|----------|
| `subject` | Объект, к которому проверяется доступ |
| `user` | Пользователь |
| `permission` | Проверяемое право |

### Возвращаемое значение

- `true` — доступ разрешен
- `false` — запрещен
