# Скрипт фильтрации значений атрибута

## Назначение

Ограничивает список возможных значений атрибута в выпадающих списках при редактировании объекта. Используется для динамической фильтрации справочников, каскадных зависимостей между полями формы.

## Место настройки

Администрирование → Классы → [Класс] → Атрибуты → [Атрибут] → Скрипт фильтрации

Требуется параметр атрибута: **"Фильтрация значений при редактировании" = да**

## Контекстные переменные

| Переменная | Тип | Описание |
|------------|-----|----------|
| `subject` | Object | Владелец атрибута. **null** в интерфейсе администратора |
| `attrCode` | String | Код фильтруемого атрибута |
| `form` | Map | Текущие значения полей формы |
| `sourceForm` | Map | Значения формы, с которой открыта текущая (для быстрых форм) |
| `origin` | String | Тип формы: addForm, editForm, readForm |
| `permittedFqns` | List | Разрешенные типы из ограничений атрибута |
| `user` | Object | Текущий пользователь |
| `cardObject` | Object | Объект карточки (null если не с карточки) |

## Структура скрипта (две части)

```groovy
//ПАРАМЕТРЫ------------------------------------------------------------
// Коды атрибутов, от которых зависит фильтрация
def DEPENDENT_ATTRS = ['clientEmployee', 'clientOU']

//ОСНОВНОЙ БЛОК--------------------------------------------------------
// ЧАСТЬ 1: Вызов в админке (subject == null)
// Возвращаем список зависимых атрибутов
if (subject == null) {
    return DEPENDENT_ATTRS
}

// ЧАСТЬ 2: Вызов на форме оператора
// Возвращаем отфильтрованный список объектов
def client = form?.clientEmployee?.parent ?: form?.clientOU
if (!client) {
    return api.filtration.disableFiltration()
}

return utils.find('service', ['clients': op.in(client)])
```

## Доступные API

### Полностью доступны
- `utils.find`, `utils.findFirst`, `utils.count`, `utils.get`
- `api.filtration.disableFiltration()` — отключить фильтрацию
- `api.ou.listNestedOUs(uuid)` — вложенные отделы
- `api.team.getTeamMembers(uuids)` — участники команд

### Ограничения
- **Нельзя** модифицировать данные (create, edit, delete)
- **Не рекомендуется** тяжелые запросы — скрипт выполняется при каждом изменении зависимых полей

## Возвращаемые значения

| Контекст | Что возвращать |
|----------|----------------|
| subject == null | Список кодов зависимых атрибутов: `['attr1', 'attr2']` или `[]` |
| Обычная фильтрация | Коллекция объектов или их UUID |
| Нет условий | `api.filtration.disableFiltration()` |
| Нет подходящих | `[]` — пустой список, нельзя ничего выбрать |

## Чек-лист проверок

### Производительность
- [ ] Используется `api.filtration.disableFiltration()` вместо `utils.find(..., [:])`
- [ ] Нет вычислимых атрибутов в условиях поиска
- [ ] Лимиты для больших справочников: `sp.limit(500)`

### Корректность
- [ ] Есть проверка `if (subject == null)` в начале
- [ ] Возвращается список атрибутов даже если он пустой: `return []`
- [ ] Null-safe доступ к `form?.attrCode`

### Зависимости
- [ ] Зависимость от атрибута комментария: `fqn@attrCode`
- [ ] При смене типа — проверить сброс значений

## Типичные ошибки

| Ошибка | Причина | Решение |
|--------|---------|---------|
| Фильтрация не срабатывает | Не указан зависимый атрибут | Добавить код в return при subject==null |
| Пустой список вместо всех | return [] вместо disableFiltration | Использовать `api.filtration.disableFiltration()` |
| Медленная форма | utils.find без лимита | Добавить sp.limit или disableFiltration |
| Дубликаты в списке | Возврат объектов и UUID вперемешку | Унифицировать: все объекты или все UUID |

## Особенности

1. **Зависимость от атрибутов комментария**: указывать как `fqn@attrCode`
2. **Агрегирующие атрибуты**: можно возвращать карты `[team$1: [employee$1, employee$2]]`
3. **metaClass**: использовать `subject.getMetainfo().toString()`, не `subject.metaClass`

## Примеры

→ См. [examples/filters.groovy](../examples/filters.groovy) (примеры 1-9)
