# Скрипт вычисления значения по умолчанию

## Назначение

Вычисляет начальное значение атрибута при создании объекта или открытии формы добавления. Выполняется однократно — при открытии формы (если атрибут на форме) или при сохранении (если не на форме).

## Место настройки

Администрирование → Классы → [Класс] → Атрибуты → [Атрибут] → Значение по умолчанию

Требуется параметр: **"Вычислимое" = да** (в разделе "Значение по умолчанию")

## Контекстные переменные

| Переменная | Тип | Описание |
|------------|-----|----------|
| `subject` | Object | Создаваемый объект. **subject.UUID = null** |
| `attrCode` | String | Код атрибута |
| `sourceForm` | Map | Значения формы, с которой открыта быстрая форма |
| `cardObject` | Object | Объект карточки, с которой вызвана форма |
| `origin` | String | Тип формы: addForm, editForm |
| `contentCode` | String | Код контента (для комментариев) |
| `user` | Object | Текущий пользователь |

## Шаблон

```groovy
//ПАРАМЕТРЫ------------------------------------------------------------
def DEFAULT_DAYS = 3

//ОСНОВНОЙ БЛОК--------------------------------------------------------
// Для формы добавления — текущий пользователь
if (origin == 'addForm') {
    return user
}

// Для редактирования — не менять
return subject?.author
```

## Доступные API

### Полностью доступны
- `utils.find`, `utils.findFirst`, `utils.get`
- `api.date.addDays`, `api.date.addHours`
- Чтение атрибутов `subject` (кроме UUID)

### Запрещено
- `utils.create`, `utils.edit`, `utils.delete`
- Обращение к `subject.UUID` — всегда null

## Возвращаемое значение

Тип должен соответствовать типу атрибута:

| Тип атрибута | Что возвращать |
|--------------|----------------|
| Ссылка на БО | Object или UUID строкой |
| Дата/время | Date: `new Date()` или `api.date.addDays(...)` |
| Строка | String |
| Число | Integer/Double |
| Набор ссылок | List объектов |

## Чек-лист проверок

### Корректность
- [ ] Не обращаться к `subject.UUID` — он null
- [ ] Не зависеть от других атрибутов с вычислимым default — порядок не определен
- [ ] Для наборов ссылок использовать `subject.attr.getObjects()`

### Производительность
- [ ] Быстрое выполнение — блокирует открытие формы
- [ ] Без обращений к внешним системам

### Особые случаи
- [ ] Проверка `origin` для разного поведения на add/edit формах
- [ ] `sourceForm` для передачи значений с родительской формы

## Типичные ошибки

| Ошибка | Причина | Решение |
|--------|---------|---------|
| `NullPointerException` | Обращение к subject.UUID | Не использовать UUID — он null |
| Неправильное значение | Зависимость от другого default-атрибута | Убрать зависимость |
| Значение не проставляется | Атрибут скрыт из-за пустого списка | Проверить фильтрацию |
| Код вместо объекта | Передана строка вместо объекта | Получить объект через utils.get |

## Особенности

1. **Порядок выполнения не определен**: Нельзя полагаться на значения других атрибутов с вычислимым default.

2. **Не срабатывает в utils.create**: Если значение передано в метод — default не вычисляется.

3. **sourceForm**: Доступна только для быстрых форм, открытых с другой формы.

4. **Агрегирующие атрибуты**: На форме добавления агрегируемые атрибуты = null, используйте `utils.getAggrValueMap()`.

## Примеры

### Текущий пользователь как автор
```groovy
if (origin == 'addForm') {
    return user
}
return subject?.author
```

### Дата через 3 рабочих дня
```groovy
def today = new Date()
def result = today
def added = 0
while (added < 3) {
    result = api.date.addDays(result, 1)
    def dayOfWeek = result.format('u') as Integer
    if (dayOfWeek < 6) added++
}
return result
```

### Значение с родительской формы
```groovy
if (sourceForm != null) {
    return sourceForm?.service
}
return null
```

→ См. [examples/attribute-scripts.groovy](../examples/attribute-scripts.groovy) (примеры 5-6)
