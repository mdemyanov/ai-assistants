# Скрипт вычисления значения атрибута (вычислимый)

## Назначение

Динамически вычисляет значение атрибута при каждом отображении. Не хранится в БД — пересчитывается при рендеринге карточки, списка, формы. Используется для агрегаций, форматирования, вычислений на основе связанных объектов.

## Место настройки

Администрирование → Классы → [Класс] → Атрибуты → Добавить атрибут

Требуется параметр: **"Вычислимый" = да**

## Контекстные переменные

| Переменная | Тип | Описание |
|------------|-----|----------|
| `subject` | Object | Текущий объект, для которого вычисляется атрибут |
| `cardObject` | Object | Объект карточки (null если не с карточки) |
| `origin` | String | Тип формы: readForm, addForm, editForm |
| `user` | Object | Текущий пользователь |

## Шаблон

```groovy
//ПАРАМЕТРЫ------------------------------------------------------------
def LINKED_ATTR = 'linkedItems'
def SUM_ATTR = 'amount'

//ОСНОВНОЙ БЛОК--------------------------------------------------------
def total = 0
def items = subject."${LINKED_ATTR}"

items?.each { item ->
    total += item."${SUM_ATTR}" ?: 0
}

return total
```

## Доступные API

### Полностью доступны
- `utils.find`, `utils.findFirst`, `utils.count`, `utils.get`
- `api.metainfo.*`
- Чтение любых атрибутов объектов

### Запрещено
- `utils.create`, `utils.edit`, `utils.delete`
- Любая модификация данных
- Обращения к внешним системам (HTTP, SOAP)

## Возвращаемое значение

Тип возвращаемого значения должен соответствовать типу атрибута:

| Тип атрибута | Что возвращать |
|--------------|----------------|
| Целое число | Integer: `return 42` |
| Дробное число | Double: `return 3.14` |
| Строка | String: `return "текст"` |
| Да/Нет | Boolean: `return true` |
| Дата | Date: `return new Date()` |
| Ссылка на БО | Object или UUID |
| Набор ссылок | List объектов или UUID |

## Чек-лист проверок

### Производительность
- [ ] **Критично:** Нет тяжелых запросов — выполняется для КАЖДОГО объекта в списке
- [ ] Используется `utils.count` вместо `utils.find(...).size()`
- [ ] Нет вложенных циклов с запросами к БД
- [ ] Кэширование результатов в локальные переменные

### Корректность
- [ ] Нет побочных эффектов (edit, create, delete)
- [ ] Null-safe обращения к связанным объектам
- [ ] Тип возвращаемого значения соответствует типу атрибута

### Ограничения
- [ ] **Нельзя использовать в utils.find** — ошибка "Could not resolve property"
- [ ] **Нельзя использовать в HQL** — атрибут не существует в БД

## Типичные ошибки

| Ошибка | Причина | Решение |
|--------|---------|---------|
| `Could not resolve property` | Вычислимый атрибут в условиях поиска | Не использовать в utils.find/count |
| Медленные списки | Тяжелая логика вычисления | Упростить или убрать из списка |
| `NullPointerException` | Обращение к null объекту | Добавить `?.` оператор |
| Пустое значение | Ошибка в скрипте | Проверить логи, атрибут заполнится null |

## Особенности

1. **Производительность**: Скрипт выполняется при КАЖДОМ отображении атрибута. В списке из 100 объектов — 100 раз.

2. **Не хранится в БД**: Нельзя искать по вычислимому атрибуту. Для поиска нужен хранимый атрибут.

3. **Ошибки молчаливы**: При ошибке атрибут получит null или значение по умолчанию, сообщение только в логе.

## Примеры

### Подсчет файлов
```groovy
return utils.count('file', ['source': subject.UUID])
```

### Сумма связанных объектов
```groovy
def items = subject.linkedItems
return items?.sum { it.amount ?: 0 } ?: 0
```

### Форматированный номер
```groovy
def prefix = 'INC'
def year = new Date().format('yy')
def num = subject.internalNumber
return num ? "${prefix}-${year}-${String.format('%06d', num)}" : null
```

→ См. [examples/attribute-scripts.groovy](../examples/attribute-scripts.groovy) (примеры 1-2, 7)
