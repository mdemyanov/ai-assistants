# Скрипт условия действия по событию

## Назначение

Определяет условия, при которых действие по событию должно выполниться. Позволяет гибко контролировать срабатывание оповещений, скриптов и других действий на основе произвольной логики.

## Место настройки

Администрирование → Действия по событиям → [Действие] → Условия → Добавить

Можно добавить несколько условий — все должны вернуть пустую строку для выполнения действия.

## Контекстные переменные

| Переменная | Тип | Описание |
|------------|-----|----------|
| `subject` | Object | Текущий объект. Состояние на момент создания события |
| `oldSubject` | Object | Объект **до** изменения (null для добавления) |
| `currentSubject` | Object | Объект с актуальными изменениями |
| `changedAttributes` | List | Коды измененных атрибутов |
| `sourceObject` | Object | Добавленный комментарий/файл |
| `escalationLevel` | Integer | Уровень эскалации |
| `commentObject` | Object | Объект комментария |
| `params` | Map | Параметры формы пользовательского действия |
| `user` | Object | Инициатор события |
| `cardObject` | Object | Карточка, с которой вызвано действие |

## Шаблон

```groovy
//ПАРАМЕТРЫ------------------------------------------------------------
def ALLOWED_STATES = ['registered', 'inProgress']
def REQUIRED_ATTRS = ['service', 'responsible']

//ОСНОВНОЙ БЛОК--------------------------------------------------------
// Проверка статуса
if (!ALLOWED_STATES.contains(subject?.state)) {
    return "Статус объекта не соответствует условию"
}

// Проверка изменения атрибутов
def hasChanges = REQUIRED_ATTRS.any { changedAttributes?.contains(it) }
if (!hasChanges) {
    return "Требуемые атрибуты не изменялись"
}

// Условие выполнено
return ""  // или return null
```

## Возвращаемые значения

| Значение | Результат |
|----------|-----------|
| `""` (пустая строка) | Условие выполнено, действие сработает |
| `null` | Условие выполнено, действие сработает |
| `"Сообщение об ошибке"` | Условие НЕ выполнено, действие НЕ сработает |

## Доступные API

### Полностью доступны
- `utils.find`, `utils.findFirst`, `utils.count`, `utils.get`
- Чтение любых атрибутов

### Не рекомендуется
- Модификация данных (create, edit, delete) — это условие, не действие
- Внешние вызовы — замедляют обработку

## Чек-лист проверок

### Корректность
- [ ] Возвращается пустая строка `""` или `null` при выполнении условия
- [ ] Возвращается непустая строка при невыполнении (для логов)
- [ ] Null-safe доступ: `subject?.state`, `changedAttributes?.contains`

### Производительность
- [ ] Быстрая проверка — блокирует обработку события
- [ ] Нет тяжелых запросов к БД
- [ ] Нет внешних вызовов

### Логика
- [ ] Порядок условий не влияет на результат (выполняются произвольно)
- [ ] Все условия должны вернуть "" для срабатывания действия

## Типичные ошибки

| Ошибка | Причина | Решение |
|--------|---------|---------|
| Действие не срабатывает | Условие возвращает непустую строку | Проверить логику, добавить логирование |
| `NullPointerException` | Обращение к null объекту | Добавить `?.` операторы |
| Медленная обработка событий | Тяжелые запросы в условии | Упростить проверку |

## Особенности

1. **Порядок выполнения**: Несколько условий выполняются в произвольном порядке.

2. **Транзакционность**: Выполняется в той же транзакции, что и действие по событию.

3. **Локализация**: Для оповещений условие проверяется отдельно для каждого языка.

## Примеры

### Проверка статуса
```groovy
def STATES = ['registered', 'assigned']
def CONTAINS = true
return STATES.contains(subject?.state) == CONTAINS ? "" : "Статус не соответствует"
```

### Проверка изменения атрибутов
```groovy
if (changedAttributes?.contains('service') || changedAttributes?.contains('respRule')) {
    return ""
}
return "Услуга и правило не изменялись"
```

### Проверка персональной ответственности
```groovy
if (subject?.responsibleEmployee != null) {
    return "Запрос уже в персональной ответственности"
}
return ""
```

### Проверка комментария при смене статуса
```groovy
def IN_CHANGE_STATE = true
if (IN_CHANGE_STATE == (comment != null)) {
    return ""
}
return "Комментарий не был добавлен при смене статуса"
```

### Комбинированное условие
```groovy
// Действие срабатывает только если:
// 1. Статус "registered" или "inProgress"
// 2. Изменился атрибут "service"
// 3. Есть ответственная команда

def ALLOWED_STATES = ['registered', 'inProgress']
def TRIGGER_ATTR = 'service'

if (!ALLOWED_STATES.contains(subject?.state)) {
    return "Недопустимый статус: ${subject?.state}"
}

if (!changedAttributes?.contains(TRIGGER_ATTR)) {
    return "Услуга не изменялась"
}

if (!subject?.responsibleTeam) {
    return "Не назначена ответственная команда"
}

return ""
```
