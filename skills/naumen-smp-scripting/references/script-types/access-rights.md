# Скрипт определения прав доступа

## Назначение

Динамически определяет права пользователя на объекты. Используется для сложной логики доступа, которую нельзя выразить через матрицу прав: доступ к "своим" объектам, иерархические права, права по атрибутам объекта.

## Место настройки

Администрирование → Роли → [Роль] → Определение условий → Скрипт

## Виды скриптов прав

| Тип | Описание | Возвращает |
|-----|----------|------------|
| Право доступа к объекту | Проверяет право конкретного пользователя на конкретный объект | Boolean |
| Список пользователей роли | Определяет, кто обладает ролью | List пользователей |
| Условия отбора объектов | Фильтр объектов, доступных обладателю роли | Условия поиска |

## Контекстные переменные

### Скрипт права доступа к объекту
| Переменная | Тип | Описание |
|------------|-----|----------|
| `subject` | Object | Объект, на который проверяется право |
| `user` | Object | Пользователь, для которого проверяется право |
| `permission` | String | Код проверяемого права |

### Скрипт списка пользователей роли
| Переменная | Тип | Описание |
|------------|-----|----------|
| `subject` | Object | Объект, относительно которого определяются пользователи |

### Скрипт условий отбора
| Переменная | Тип | Описание |
|------------|-----|----------|
| `user` | Object | Текущий пользователь |

## Шаблоны

### Право доступа к объекту
```groovy
//ПАРАМЕТРЫ------------------------------------------------------------
def ALLOWED_PERMISSIONS = ['read', 'edit']

//ОСНОВНОЙ БЛОК--------------------------------------------------------
// Проверка права
if (!ALLOWED_PERMISSIONS.contains(permission)) {
    return false
}

// Пользователь видит только свои запросы
if (subject.clientEmployee?.UUID == user?.UUID) {
    return true
}

// Руководитель видит запросы подчиненных
if (subject.clientEmployee?.parent?.UUID == user?.parent?.UUID) {
    return true
}

return false
```

### Список пользователей роли
```groovy
//ОСНОВНОЙ БЛОК--------------------------------------------------------
// Ответственные за услугу
def service = subject?.service
if (!service) return []

def users = []

// Ответственные сотрудники услуги
users.addAll(service.responsibleEmployees ?: [])

// Участники ответственных команд
service.responsibleTeams?.each { team ->
    users.addAll(team.members ?: [])
}

return users.unique { it.UUID }
```

### Условия отбора объектов
```groovy
//ОСНОВНОЙ БЛОК--------------------------------------------------------
// Пользователь видит запросы своего отдела
def userOU = user?.parent

if (!userOU) {
    return ['UUID': op.in([])]  // Ничего не показывать
}

// Условие: контрагент из того же отдела
return ['clientOU': userOU.UUID]
```

## Доступные API

### Полностью доступны
- `utils.find`, `utils.findFirst`, `utils.get`
- Чтение атрибутов объектов
- `api.team.getTeamMembers`

### Не рекомендуется
- Модификация данных — это проверка прав, не действие
- Тяжелые запросы — вызывается часто

## Чек-лист проверок

### Производительность
- [ ] Минимум обращений к БД — вызывается при каждой проверке
- [ ] Кэширование справочников
- [ ] Быстрые проверки первыми (fail-fast)

### Корректность
- [ ] Обработка null: `user?.parent`, `subject?.service`
- [ ] Явный return true/false
- [ ] Учет всех веток условий

### Безопасность
- [ ] Проверка permission для ограничения операций
- [ ] Защита от null user (системные операции)

## Типичные ошибки

| Ошибка | Причина | Решение |
|--------|---------|---------|
| Всегда нет доступа | Нет return true | Добавить явный return |
| Медленные списки | Тяжелая логика в скрипте | Оптимизировать, кэшировать |
| Доступ есть, но объект не в списке | Условия отбора не совпадают с правом | Синхронизировать логику |
| NullPointerException | user = null при системных операциях | Проверка на null |

## Особенности

1. **Производительность критична**: Скрипт вызывается при каждой проверке прав — на каждой карточке, в каждом списке.

2. **Три уровня проверки**: Право на объект → Список пользователей роли → Условия отбора. Должны быть согласованы.

3. **Системные операции**: При системных вызовах user может быть null — обрабатывайте этот случай.

## Примеры

### Доступ к своим запросам и запросам подчиненных
```groovy
if (!user) return false

// Свои запросы
if (subject.clientEmployee?.UUID == user.UUID) {
    return true
}

// Запросы подчиненных
def subordinates = utils.find('employee', ['immediateSupervisor': user.UUID])
def subordinateUUIDs = subordinates*.UUID

if (subject.clientEmployee?.UUID in subordinateUUIDs) {
    return true
}

return false
```

### Условия для VIP-менеджера
```groovy
// VIP-менеджер видит только VIP-клиентов
if (user?.roles?.any { it.code == 'vipManager' }) {
    return ['clientEmployee.vipStatus': true]
}

// Обычный менеджер — обычных клиентов
return ['clientEmployee.vipStatus': op.orEq(false, null)]
```

### Динамический список пользователей
```groovy
def result = []

// Ответственный сотрудник
if (subject.responsibleEmployee) {
    result.add(subject.responsibleEmployee)
}

// Участники ответственной команды
if (subject.responsibleTeam) {
    result.addAll(api.team.getTeamMembers([subject.responsibleTeam.UUID], false))
}

// Руководитель ответственного
def supervisor = subject.responsibleEmployee?.immediateSupervisor
if (supervisor) {
    result.add(supervisor)
}

return result.unique { it.UUID }
```
