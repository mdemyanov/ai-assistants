# Скрипт действия по событию (системное)

## Назначение

Автоматически выполняет действия при наступлении системных событий: добавление, редактирование, удаление объекта, смена статуса, добавление комментария и т.д. Основной инструмент автоматизации бизнес-процессов.

## Место настройки

Администрирование → Действия по событиям → Добавить → Тип: Скрипт

## Контекстные переменные

| Переменная | Тип | Описание |
|------------|-----|----------|
| `subject` | Object | Текущий объект. Состояние на момент **постановки в очередь** |
| `oldSubject` | Object | Объект **до** изменения. null для добавления |
| `currentSubject` | Object | Объект с **актуальными** изменениями от предыдущих действий |
| `changedAttributes` | List | Коды измененных атрибутов |
| `sourceObject` | Object | Добавленный комментарий/файл (для событий добавления) |
| `comment` | String | Текст комментария при смене статуса/ответственного |
| `commentObject` | Object | Объект созданного комментария |
| `escalationLevel` | Integer | Уровень эскалации (для событий эскалации) |
| `user` | Object | Инициатор события. null для суперпользователя |
| `cardObject` | Object | Карточка, с которой вызвано событие |

## Шаблон

```groovy
//ПАРАМЕТРЫ------------------------------------------------------------
def TARGET_STATE = 'inProgress'
def ALLOWED_STATES = ['registered', 'assigned']

//ОСНОВНОЙ БЛОК--------------------------------------------------------
// Проверка, что нужный атрибут изменился
if (!changedAttributes.contains('responsibleEmployee')) {
    return
}

// Проверка условий
if (!ALLOWED_STATES.contains(subject.state)) {
    return
}

// Выполнение действия
utils.edit(subject, [
    'state': TARGET_STATE,
    '@user': user  // Передаем user в цепочку
])

logger.info("Статус изменен: ${subject.number} → ${TARGET_STATE}")
```

## Доступные API

### Полностью доступны
- `utils.find`, `utils.findFirst`, `utils.count`, `utils.get`
- `utils.create`, `utils.edit`, `utils.delete`
- `api.http.*`, `api.soap.*` (для интеграций)
- `api.mail.sendMail`
- `api.utils.attachFile`

### Особенности
- `utils.editWithoutEventActions` — редактирование без триггера новых событий
- `@user` — передача пользователя в цепочку действий

## Типы событий

| Событие | subject | oldSubject | sourceObject |
|---------|---------|------------|--------------|
| Добавление объекта | Созданный объект | null | null |
| Редактирование | Текущий объект | До изменения | null |
| Удаление | null | Удаленный объект | null |
| Смена статуса | Текущий объект | До смены | null |
| Добавление комментария | Объект-владелец | null | Комментарий |
| Добавление файла | Объект-владелец | null | Файл |

## Синхронность

| Режим | Описание | Когда использовать |
|-------|----------|-------------------|
| **Синхронное** | Блокирует интерфейс. Откат при ошибке | Критичные проверки, валидация |
| **Асинхронное** | В фоне, не влияет на транзакцию | Уведомления, логирование |
| **Внешняя операция** | Отдельная очередь для интеграций | HTTP/SOAP запросы |

## Чек-лист проверок

### Производительность
- [ ] Проверка `changedAttributes` перед тяжелой логикой
- [ ] `sp.limit()` для поисковых запросов
- [ ] Единый `utils.edit` вместо нескольких

### Безопасность
- [ ] Передача `@user` в utils.edit для сохранения контекста
- [ ] Обработка ошибок интеграций (try-catch)

### Корректность
- [ ] Проверка на null: `subject?.attr`, `oldSubject?.attr`
- [ ] Использование `currentSubject` для актуальных данных
- [ ] Избегание зацикливания (глубина событий ≤ 8)

## Типичные ошибки

| Ошибка | Причина | Решение |
|--------|---------|---------|
| Зацикливание | Действие триггерит само себя | Проверка changedAttributes |
| user = null | Не передан @user в edit | Добавить `'@user': user` |
| Старые данные | Использование subject вместо currentSubject | Использовать currentSubject |
| oldSubject.reverseLinks = null | Обратные ссылки недоступны в oldSubject | Делать отдельный поиск |

## Особенности

1. **subject vs currentSubject**: `subject` — состояние на момент постановки в очередь, `currentSubject` — актуальное с учетом предыдущих действий.

2. **Глубина событий**: Максимум 8 уровней вложенности для защиты от зацикливания.

3. **Обратные ссылки в oldSubject**: Всегда null — делайте отдельный поиск.

4. **Цепочка событий**: Передавайте `@user` в utils.edit для сохранения контекста пользователя.

## Примеры

### Комментарий при изменении названия
```groovy
if (changedAttributes.contains('title')) {
    utils.create('comment', [
        'text': "Старое название: ${oldSubject.title}",
        'source': subject.UUID
    ])
}
```

### Автоназначение при принятии в работу
```groovy
if (subject.responsibleEmployee && ['registered'].contains(subject.state)) {
    utils.edit(subject, [
        'state': 'accepted',
        '@user': user
    ])
}
```

→ См. [examples/event-actions.groovy](../examples/event-actions.groovy) (примеры 1-4, 7-8)
